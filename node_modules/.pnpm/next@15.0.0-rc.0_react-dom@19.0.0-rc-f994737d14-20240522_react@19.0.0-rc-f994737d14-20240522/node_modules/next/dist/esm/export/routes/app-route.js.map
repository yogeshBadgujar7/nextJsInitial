{"version":3,"sources":["../../../src/export/routes/app-route.ts"],"sourcesContent":["import type { ExportRouteResult, FileWriter } from '../types'\nimport type AppRouteRouteModule from '../../server/future/route-modules/app-route/module'\nimport type { AppRouteRouteHandlerContext } from '../../server/future/route-modules/app-route/module'\nimport type { IncrementalCache } from '../../server/lib/incremental-cache'\n\nimport { join } from 'path'\nimport {\n  NEXT_BODY_SUFFIX,\n  NEXT_CACHE_TAGS_HEADER,\n  NEXT_META_SUFFIX,\n} from '../../lib/constants'\nimport { NodeNextRequest } from '../../server/base-http/node'\nimport { RouteModuleLoader } from '../../server/future/helpers/module-loader/route-module-loader'\nimport {\n  NextRequestAdapter,\n  signalFromNodeResponse,\n} from '../../server/web/spec-extension/adapters/next-request'\nimport { toNodeOutgoingHttpHeaders } from '../../server/web/utils'\nimport type {\n  MockedRequest,\n  MockedResponse,\n} from '../../server/lib/mock-request'\nimport { isDynamicUsageError } from '../helpers/is-dynamic-usage-error'\nimport { SERVER_DIRECTORY } from '../../shared/lib/constants'\nimport { hasNextSupport } from '../../telemetry/ci-info'\nimport { isStaticGenEnabled } from '../../server/future/route-modules/app-route/helpers/is-static-gen-enabled'\nimport type { ExperimentalConfig } from '../../server/config-shared'\nimport {\n  isMetadataRouteFile,\n  isStaticMetadataRoute,\n} from '../../lib/metadata/is-metadata-route'\nimport { normalizeAppPath } from '../../shared/lib/router/utils/app-paths'\n\nexport const enum ExportedAppRouteFiles {\n  BODY = 'BODY',\n  META = 'META',\n}\n\nexport async function exportAppRoute(\n  req: MockedRequest,\n  res: MockedResponse,\n  params: { [key: string]: string | string[] } | undefined,\n  page: string,\n  incrementalCache: IncrementalCache | undefined,\n  distDir: string,\n  htmlFilepath: string,\n  fileWriter: FileWriter,\n  experimental: Required<Pick<ExperimentalConfig, 'after'>>\n): Promise<ExportRouteResult> {\n  // Ensure that the URL is absolute.\n  req.url = `http://localhost:3000${req.url}`\n\n  // Adapt the request and response to the Next.js request and response.\n  const request = NextRequestAdapter.fromNodeNextRequest(\n    new NodeNextRequest(req),\n    signalFromNodeResponse(res)\n  )\n\n  // Create the context for the handler. This contains the params from\n  // the route and the context for the request.\n  const context: AppRouteRouteHandlerContext = {\n    params,\n    prerenderManifest: {\n      version: 4,\n      routes: {},\n      dynamicRoutes: {},\n      preview: {\n        previewModeEncryptionKey: '',\n        previewModeId: '',\n        previewModeSigningKey: '',\n      },\n      notFoundRoutes: [],\n    },\n    renderOpts: {\n      experimental: experimental,\n      originalPathname: page,\n      nextExport: true,\n      supportsDynamicHTML: false,\n      incrementalCache,\n      waitUntil: undefined,\n      onClose: undefined,\n    },\n  }\n\n  if (hasNextSupport) {\n    context.renderOpts.isRevalidate = true\n  }\n\n  // This is a route handler, which means it has it's handler in the\n  // bundled file already, we should just use that.\n  const filename = join(distDir, SERVER_DIRECTORY, 'app', page)\n\n  try {\n    // Route module loading and handling.\n    const module = await RouteModuleLoader.load<AppRouteRouteModule>(filename)\n    const userland = module.userland\n    // we don't bail from the static optimization for\n    // metadata routes\n    const normalizedPage = normalizeAppPath(page)\n    const isMetadataRoute =\n      isStaticMetadataRoute(normalizedPage) ||\n      isMetadataRouteFile(`${normalizedPage}.ts`, ['ts'], true)\n\n    if (!isStaticGenEnabled(userland) && !isMetadataRoute) {\n      return { revalidate: 0 }\n    }\n\n    const response = await module.handle(request, context)\n\n    const isValidStatus = response.status < 400 || response.status === 404\n    if (!isValidStatus) {\n      return { revalidate: 0 }\n    }\n\n    const blob = await response.blob()\n    const revalidate =\n      typeof context.renderOpts.store?.revalidate === 'undefined'\n        ? false\n        : context.renderOpts.store.revalidate\n\n    const headers = toNodeOutgoingHttpHeaders(response.headers)\n    const cacheTags = (context.renderOpts as any).fetchTags\n\n    if (cacheTags) {\n      headers[NEXT_CACHE_TAGS_HEADER] = cacheTags\n    }\n\n    if (!headers['content-type'] && blob.type) {\n      headers['content-type'] = blob.type\n    }\n\n    // Writing response body to a file.\n    const body = Buffer.from(await blob.arrayBuffer())\n    await fileWriter(\n      ExportedAppRouteFiles.BODY,\n      htmlFilepath.replace(/\\.html$/, NEXT_BODY_SUFFIX),\n      body,\n      'utf8'\n    )\n\n    // Write the request metadata to a file.\n    const meta = { status: response.status, headers }\n    await fileWriter(\n      ExportedAppRouteFiles.META,\n      htmlFilepath.replace(/\\.html$/, NEXT_META_SUFFIX),\n      JSON.stringify(meta)\n    )\n\n    return {\n      revalidate: revalidate,\n      metadata: meta,\n    }\n  } catch (err) {\n    if (!isDynamicUsageError(err)) {\n      throw err\n    }\n\n    return { revalidate: 0 }\n  }\n}\n"],"names":["join","NEXT_BODY_SUFFIX","NEXT_CACHE_TAGS_HEADER","NEXT_META_SUFFIX","NodeNextRequest","RouteModuleLoader","NextRequestAdapter","signalFromNodeResponse","toNodeOutgoingHttpHeaders","isDynamicUsageError","SERVER_DIRECTORY","hasNextSupport","isStaticGenEnabled","isMetadataRouteFile","isStaticMetadataRoute","normalizeAppPath","ExportedAppRouteFiles","exportAppRoute","req","res","params","page","incrementalCache","distDir","htmlFilepath","fileWriter","experimental","url","request","fromNodeNextRequest","context","prerenderManifest","version","routes","dynamicRoutes","preview","previewModeEncryptionKey","previewModeId","previewModeSigningKey","notFoundRoutes","renderOpts","originalPathname","nextExport","supportsDynamicHTML","waitUntil","undefined","onClose","isRevalidate","filename","module","load","userland","normalizedPage","isMetadataRoute","revalidate","response","handle","isValidStatus","status","blob","store","headers","cacheTags","fetchTags","type","body","Buffer","from","arrayBuffer","replace","meta","JSON","stringify","metadata","err"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":"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"}