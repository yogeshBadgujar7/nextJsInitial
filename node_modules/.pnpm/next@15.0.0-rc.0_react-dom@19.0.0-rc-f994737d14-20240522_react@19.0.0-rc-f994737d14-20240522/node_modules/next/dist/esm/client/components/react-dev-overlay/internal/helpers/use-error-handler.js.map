{"version":3,"sources":["../../../../../../src/client/components/react-dev-overlay/internal/helpers/use-error-handler.ts"],"sourcesContent":["import { useEffect } from 'react'\nimport {\n  hydrationErrorState,\n  getReactHydrationDiffSegments,\n} from './hydration-error-info'\nimport { isNextRouterError } from '../../../is-next-router-error'\nimport {\n  isHydrationError,\n  getDefaultHydrationErrorMessage,\n} from '../../../is-hydration-error'\n\nexport type ErrorHandler = (error: Error) => void\n\nif (typeof window !== 'undefined') {\n  try {\n    // Increase the number of stack frames on the client\n    Error.stackTraceLimit = 50\n  } catch {}\n}\n\nlet hasHydrationError = false\nconst errorQueue: Array<Error> = []\nconst rejectionQueue: Array<Error> = []\nconst errorHandlers: Array<ErrorHandler> = []\nconst rejectionHandlers: Array<ErrorHandler> = []\n\nif (typeof window !== 'undefined') {\n  function handleError(error: unknown) {\n    if (isNextRouterError(error)) {\n      return false\n    }\n\n    if (\n      !error ||\n      !(error instanceof Error) ||\n      typeof error.stack !== 'string'\n    ) {\n      // A non-error was thrown, we don't have anything to show. :-(\n      return\n    }\n\n    const isCausedByHydrationFailure = isHydrationError(error)\n    if (\n      isHydrationError(error) &&\n      !error.message.includes(\n        'https://nextjs.org/docs/messages/react-hydration-error'\n      )\n    ) {\n      const reactHydrationDiffSegments = getReactHydrationDiffSegments(\n        error.message\n      )\n      let parsedHydrationErrorState: typeof hydrationErrorState = {}\n      if (reactHydrationDiffSegments) {\n        parsedHydrationErrorState = {\n          ...(error as any).details,\n          ...hydrationErrorState,\n          warning: hydrationErrorState.warning || [\n            getDefaultHydrationErrorMessage(),\n          ],\n          notes: reactHydrationDiffSegments[0],\n          reactOutputComponentDiff: reactHydrationDiffSegments[1],\n        }\n      } else {\n        // If there's any extra information in the error message to display,\n        // append it to the error message details property\n        if (hydrationErrorState.warning) {\n          // The patched console.error found hydration errors logged by React\n          // Append the logged warning to the error message\n          parsedHydrationErrorState = {\n            ...(error as any).details,\n            // It contains the warning, component stack, server and client tag names\n            ...hydrationErrorState,\n          }\n        }\n        error.message +=\n          '\\nSee more info here: https://nextjs.org/docs/messages/react-hydration-error'\n      }\n      ;(error as any).details = parsedHydrationErrorState\n    }\n\n    // Only queue one hydration every time\n    if (isCausedByHydrationFailure) {\n      if (!hasHydrationError) {\n        errorQueue.push(error)\n      }\n      hasHydrationError = true\n    }\n    for (const handler of errorHandlers) {\n      handler(error)\n    }\n  }\n  // These event handlers must be added outside of the hook because there is no\n  // guarantee that the hook will be alive in a mounted component in time to\n  // when the errors occur.\n  // uncaught errors go through reportError\n  window.addEventListener(\n    'error',\n    (event: WindowEventMap['error']): void | boolean => {\n      if (handleError(event.error) === false) {\n        event.preventDefault()\n        return false\n      }\n    }\n  )\n  // caught errors go through console.error\n  const origConsoleError = window.console.error\n  window.console.error = (...args) => {\n    // See https://github.com/facebook/react/blob/d50323eb845c5fde0d720cae888bf35dedd05506/packages/react-reconciler/src/ReactFiberErrorLogger.js#L78\n    const error = process.env.NODE_ENV !== 'production' ? args[1] : args[0]\n    if (handleError(error) !== false) {\n      origConsoleError.apply(window.console, args)\n    }\n  }\n  window.addEventListener(\n    'unhandledrejection',\n    (ev: WindowEventMap['unhandledrejection']): void => {\n      const reason = ev?.reason\n      if (\n        !reason ||\n        !(reason instanceof Error) ||\n        typeof reason.stack !== 'string'\n      ) {\n        // A non-error was thrown, we don't have anything to show. :-(\n        return\n      }\n\n      const e = reason\n      rejectionQueue.push(e)\n      for (const handler of rejectionHandlers) {\n        handler(e)\n      }\n    }\n  )\n}\n\nexport function useErrorHandler(\n  handleOnUnhandledError: ErrorHandler,\n  handleOnUnhandledRejection: ErrorHandler\n) {\n  useEffect(() => {\n    // Handle queued errors.\n    errorQueue.forEach(handleOnUnhandledError)\n    rejectionQueue.forEach(handleOnUnhandledRejection)\n\n    // Listen to new errors.\n    errorHandlers.push(handleOnUnhandledError)\n    rejectionHandlers.push(handleOnUnhandledRejection)\n\n    return () => {\n      // Remove listeners.\n      errorHandlers.splice(errorHandlers.indexOf(handleOnUnhandledError), 1)\n      rejectionHandlers.splice(\n        rejectionHandlers.indexOf(handleOnUnhandledRejection),\n        1\n      )\n    }\n  }, [handleOnUnhandledError, handleOnUnhandledRejection])\n}\n"],"names":["useEffect","hydrationErrorState","getReactHydrationDiffSegments","isNextRouterError","isHydrationError","getDefaultHydrationErrorMessage","window","Error","stackTraceLimit","hasHydrationError","errorQueue","rejectionQueue","errorHandlers","rejectionHandlers","handleError","error","stack","isCausedByHydrationFailure","message","includes","reactHydrationDiffSegments","parsedHydrationErrorState","details","warning","notes","reactOutputComponentDiff","push","handler","addEventListener","event","preventDefault","origConsoleError","console","args","process","env","NODE_ENV","apply","ev","reason","e","useErrorHandler","handleOnUnhandledError","handleOnUnhandledRejection","forEach","splice","indexOf"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":"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"}