{"version":3,"sources":["../../../src/server/async-storage/request-async-storage-wrapper.ts"],"sourcesContent":["import type { BaseNextRequest, BaseNextResponse } from '../base-http'\nimport type { IncomingHttpHeaders, IncomingMessage, ServerResponse } from 'http'\nimport type { AsyncLocalStorage } from 'async_hooks'\nimport type { RequestStore } from '../../client/components/request-async-storage.external'\nimport type { RenderOpts } from '../app-render/types'\nimport type { AsyncStorageWrapper } from './async-storage-wrapper'\nimport type { NextRequest } from '../web/spec-extension/request'\nimport type { __ApiPreviewProps } from '../api-utils'\n\nimport { FLIGHT_PARAMETERS } from '../../client/components/app-router-headers'\nimport {\n  HeadersAdapter,\n  type ReadonlyHeaders,\n} from '../web/spec-extension/adapters/headers'\nimport {\n  MutableRequestCookiesAdapter,\n  RequestCookiesAdapter,\n  type ReadonlyRequestCookies,\n} from '../web/spec-extension/adapters/request-cookies'\nimport { ResponseCookies, RequestCookies } from '../web/spec-extension/cookies'\nimport { DraftModeProvider } from './draft-mode-provider'\nimport { splitCookiesString } from '../web/utils'\nimport { createAfterContext, type AfterContext } from '../after/after-context'\nimport type { RequestLifecycleOpts } from '../base-server'\n\nfunction getHeaders(headers: Headers | IncomingHttpHeaders): ReadonlyHeaders {\n  const cleaned = HeadersAdapter.from(headers)\n  for (const param of FLIGHT_PARAMETERS) {\n    cleaned.delete(param.toString().toLowerCase())\n  }\n\n  return HeadersAdapter.seal(cleaned)\n}\n\nfunction getMutableCookies(\n  headers: Headers | IncomingHttpHeaders,\n  onUpdateCookies?: (cookies: string[]) => void\n): ResponseCookies {\n  const cookies = new RequestCookies(HeadersAdapter.from(headers))\n  return MutableRequestCookiesAdapter.wrap(cookies, onUpdateCookies)\n}\n\nexport type WrapperRenderOpts = Omit<RenderOpts, 'experimental'> &\n  RequestLifecycleOpts &\n  Partial<\n    Pick<\n      RenderOpts,\n      'ComponentMod' // can be undefined in a route handler\n    >\n  > & {\n    experimental: Pick<RenderOpts['experimental'], 'after'>\n  }\n\nexport type RequestContext = {\n  req: IncomingMessage | BaseNextRequest | NextRequest\n  res?: ServerResponse | BaseNextResponse\n  renderOpts?: WrapperRenderOpts\n}\n\nexport const RequestAsyncStorageWrapper: AsyncStorageWrapper<\n  RequestStore,\n  RequestContext\n> = {\n  /**\n   * Wrap the callback with the given store so it can access the underlying\n   * store using hooks.\n   *\n   * @param storage underlying storage object returned by the module\n   * @param context context to seed the store\n   * @param callback function to call within the scope of the context\n   * @returns the result returned by the callback\n   */\n  wrap<Result>(\n    storage: AsyncLocalStorage<RequestStore>,\n    { req, res, renderOpts }: RequestContext,\n    callback: (store: RequestStore) => Result\n  ): Result {\n    let previewProps: __ApiPreviewProps | undefined = undefined\n\n    if (renderOpts && 'previewProps' in renderOpts) {\n      // TODO: investigate why previewProps isn't on RenderOpts\n      previewProps = (renderOpts as any).previewProps\n    }\n\n    const [wrapWithAfter, afterContext] = createAfterWrapper(renderOpts)\n\n    function defaultOnUpdateCookies(cookies: string[]) {\n      if (res) {\n        res.setHeader('Set-Cookie', cookies)\n      }\n    }\n\n    const cache: {\n      headers?: ReadonlyHeaders\n      cookies?: ReadonlyRequestCookies\n      mutableCookies?: ResponseCookies\n      draftMode?: DraftModeProvider\n    } = {}\n\n    const store: RequestStore = {\n      get headers() {\n        if (!cache.headers) {\n          // Seal the headers object that'll freeze out any methods that could\n          // mutate the underlying data.\n          cache.headers = getHeaders(req.headers)\n        }\n\n        return cache.headers\n      },\n      get cookies() {\n        if (!cache.cookies) {\n          // if middleware is setting cookie(s), then include those in\n          // the initial cached cookies so they can be read in render\n          const requestCookies = new RequestCookies(\n            HeadersAdapter.from(req.headers)\n          )\n\n          if (\n            'x-middleware-set-cookie' in req.headers &&\n            typeof req.headers['x-middleware-set-cookie'] === 'string'\n          ) {\n            const setCookieValue = req.headers['x-middleware-set-cookie']\n            const responseHeaders = new Headers()\n\n            for (const cookie of splitCookiesString(setCookieValue)) {\n              responseHeaders.append('set-cookie', cookie)\n            }\n\n            const responseCookies = new ResponseCookies(responseHeaders)\n\n            // Transfer cookies from ResponseCookies to RequestCookies\n            for (const cookie of responseCookies.getAll()) {\n              requestCookies.set(cookie.name, cookie.value ?? '')\n            }\n          }\n\n          // Seal the cookies object that'll freeze out any methods that could\n          // mutate the underlying data.\n          cache.cookies = RequestCookiesAdapter.seal(requestCookies)\n        }\n\n        return cache.cookies\n      },\n      get mutableCookies() {\n        if (!cache.mutableCookies) {\n          cache.mutableCookies = getMutableCookies(\n            req.headers,\n            renderOpts?.onUpdateCookies ||\n              (res ? defaultOnUpdateCookies : undefined)\n          )\n        }\n        return cache.mutableCookies\n      },\n      get draftMode() {\n        if (!cache.draftMode) {\n          cache.draftMode = new DraftModeProvider(\n            previewProps,\n            req,\n            this.cookies,\n            this.mutableCookies\n          )\n        }\n\n        return cache.draftMode\n      },\n\n      reactLoadableManifest: renderOpts?.reactLoadableManifest || {},\n      assetPrefix: renderOpts?.assetPrefix || '',\n      afterContext,\n    }\n    return wrapWithAfter(store, () => storage.run(store, callback, store))\n  },\n}\n\nfunction createAfterWrapper(\n  renderOpts: WrapperRenderOpts | undefined\n): [\n  wrap: <Result>(requestStore: RequestStore, callback: () => Result) => Result,\n  afterContext: AfterContext | undefined,\n] {\n  const isAfterEnabled = renderOpts?.experimental?.after ?? false\n  if (!renderOpts || !isAfterEnabled) {\n    return [(_, callback) => callback(), undefined]\n  }\n\n  const { waitUntil, onClose } = renderOpts\n  const cacheScope = renderOpts.ComponentMod?.createCacheScope()\n\n  const afterContext = createAfterContext({\n    waitUntil,\n    onClose,\n    cacheScope,\n  })\n\n  const wrap = <Result>(requestStore: RequestStore, callback: () => Result) =>\n    afterContext.run(requestStore, callback)\n\n  return [wrap, afterContext]\n}\n"],"names":["FLIGHT_PARAMETERS","HeadersAdapter","MutableRequestCookiesAdapter","RequestCookiesAdapter","ResponseCookies","RequestCookies","DraftModeProvider","splitCookiesString","createAfterContext","getHeaders","headers","cleaned","from","param","delete","toString","toLowerCase","seal","getMutableCookies","onUpdateCookies","cookies","wrap","RequestAsyncStorageWrapper","storage","req","res","renderOpts","callback","previewProps","undefined","wrapWithAfter","afterContext","createAfterWrapper","defaultOnUpdateCookies","setHeader","cache","store","requestCookies","setCookieValue","responseHeaders","Headers","cookie","append","responseCookies","getAll","set","name","value","mutableCookies","draftMode","reactLoadableManifest","assetPrefix","run","isAfterEnabled","experimental","after","_","waitUntil","onClose","cacheScope","ComponentMod","createCacheScope","requestStore"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":"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"}