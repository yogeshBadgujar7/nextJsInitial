{"version":3,"sources":["../../../../src/server/web/spec-extension/revalidate.ts"],"sourcesContent":["import { trackDynamicDataAccessed } from '../../app-render/dynamic-rendering'\nimport { isDynamicRoute } from '../../../shared/lib/router/utils'\nimport {\n  NEXT_CACHE_IMPLICIT_TAG_ID,\n  NEXT_CACHE_SOFT_TAG_MAX_LENGTH,\n} from '../../../lib/constants'\nimport { getPathname } from '../../../lib/url'\nimport { staticGenerationAsyncStorage } from '../../../client/components/static-generation-async-storage.external'\n\n/**\n * This function allows you to purge [cached data](https://nextjs.org/docs/app/building-your-application/caching) on-demand for a specific cache tag.\n *\n * Read more: [Next.js Docs: `revalidateTag`](https://nextjs.org/docs/app/api-reference/functions/revalidateTag)\n */\nexport function revalidateTag(tag: string) {\n  return revalidate(tag, `revalidateTag ${tag}`)\n}\n\n/**\n * This function allows you to purge [cached data](https://nextjs.org/docs/app/building-your-application/caching) on-demand for a specific path.\n *\n * Read more: [Next.js Docs: `revalidatePath`](https://nextjs.org/docs/app/api-reference/functions/revalidatePath)\n */\nexport function revalidatePath(originalPath: string, type?: 'layout' | 'page') {\n  if (originalPath.length > NEXT_CACHE_SOFT_TAG_MAX_LENGTH) {\n    console.warn(\n      `Warning: revalidatePath received \"${originalPath}\" which exceeded max length of ${NEXT_CACHE_SOFT_TAG_MAX_LENGTH}. See more info here https://nextjs.org/docs/app/api-reference/functions/revalidatePath`\n    )\n    return\n  }\n\n  let normalizedPath = `${NEXT_CACHE_IMPLICIT_TAG_ID}${originalPath}`\n\n  if (type) {\n    normalizedPath += `${normalizedPath.endsWith('/') ? '' : '/'}${type}`\n  } else if (isDynamicRoute(originalPath)) {\n    console.warn(\n      `Warning: a dynamic page path \"${originalPath}\" was passed to \"revalidatePath\", but the \"type\" parameter is missing. This has no effect by default, see more info here https://nextjs.org/docs/app/api-reference/functions/revalidatePath`\n    )\n  }\n  return revalidate(normalizedPath, `revalidatePath ${originalPath}`)\n}\n\nfunction revalidate(tag: string, expression: string) {\n  const store = staticGenerationAsyncStorage.getStore()\n  if (!store || !store.incrementalCache) {\n    throw new Error(\n      `Invariant: static generation store missing in ${expression}`\n    )\n  }\n\n  if (store.isUnstableCacheCallback) {\n    throw new Error(\n      `Route ${getPathname(\n        store.urlPathname\n      )} used \"${expression}\" inside a function cached with \"unstable_cache(...)\" which is unsupported. To ensure revalidation is performed consistently it must always happen outside of renders and cached functions. See more info here: https://nextjs.org/docs/app/building-your-application/rendering/static-and-dynamic#dynamic-rendering`\n    )\n  }\n\n  // a route that makes use of revalidation APIs should be considered dynamic\n  // as otherwise it would be impossible to revalidate\n  trackDynamicDataAccessed(store, expression)\n\n  if (!store.revalidatedTags) {\n    store.revalidatedTags = []\n  }\n  if (!store.revalidatedTags.includes(tag)) {\n    store.revalidatedTags.push(tag)\n  }\n\n  // TODO: only revalidate if the path matches\n  store.pathWasRevalidated = true\n}\n"],"names":["trackDynamicDataAccessed","isDynamicRoute","NEXT_CACHE_IMPLICIT_TAG_ID","NEXT_CACHE_SOFT_TAG_MAX_LENGTH","getPathname","staticGenerationAsyncStorage","revalidateTag","tag","revalidate","revalidatePath","originalPath","type","length","console","warn","normalizedPath","endsWith","expression","store","getStore","incrementalCache","Error","isUnstableCacheCallback","urlPathname","revalidatedTags","includes","push","pathWasRevalidated"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":"AAAA,SAASA,wBAAwB,QAAQ,qCAAoC;AAC7E,SAASC,cAAc,QAAQ,mCAAkC;AACjE,SACEC,0BAA0B,EAC1BC,8BAA8B,QACzB,yBAAwB;AAC/B,SAASC,WAAW,QAAQ,mBAAkB;AAC9C,SAASC,4BAA4B,QAAQ,sEAAqE;AAElH;;;;CAIC,GACD,OAAO,SAASC,cAAcC,GAAW;IACvC,OAAOC,WAAWD,KAAK,CAAC,cAAc,EAAEA,IAAI,CAAC;AAC/C;AAEA;;;;CAIC,GACD,OAAO,SAASE,eAAeC,YAAoB,EAAEC,IAAwB;IAC3E,IAAID,aAAaE,MAAM,GAAGT,gCAAgC;QACxDU,QAAQC,IAAI,CACV,CAAC,kCAAkC,EAAEJ,aAAa,+BAA+B,EAAEP,+BAA+B,uFAAuF,CAAC;QAE5M;IACF;IAEA,IAAIY,iBAAiB,CAAC,EAAEb,2BAA2B,EAAEQ,aAAa,CAAC;IAEnE,IAAIC,MAAM;QACRI,kBAAkB,CAAC,EAAEA,eAAeC,QAAQ,CAAC,OAAO,KAAK,IAAI,EAAEL,KAAK,CAAC;IACvE,OAAO,IAAIV,eAAeS,eAAe;QACvCG,QAAQC,IAAI,CACV,CAAC,8BAA8B,EAAEJ,aAAa,2LAA2L,CAAC;IAE9O;IACA,OAAOF,WAAWO,gBAAgB,CAAC,eAAe,EAAEL,aAAa,CAAC;AACpE;AAEA,SAASF,WAAWD,GAAW,EAAEU,UAAkB;IACjD,MAAMC,QAAQb,6BAA6Bc,QAAQ;IACnD,IAAI,CAACD,SAAS,CAACA,MAAME,gBAAgB,EAAE;QACrC,MAAM,IAAIC,MACR,CAAC,8CAA8C,EAAEJ,WAAW,CAAC;IAEjE;IAEA,IAAIC,MAAMI,uBAAuB,EAAE;QACjC,MAAM,IAAID,MACR,CAAC,MAAM,EAAEjB,YACPc,MAAMK,WAAW,EACjB,OAAO,EAAEN,WAAW,oTAAoT,CAAC;IAE/U;IAEA,2EAA2E;IAC3E,oDAAoD;IACpDjB,yBAAyBkB,OAAOD;IAEhC,IAAI,CAACC,MAAMM,eAAe,EAAE;QAC1BN,MAAMM,eAAe,GAAG,EAAE;IAC5B;IACA,IAAI,CAACN,MAAMM,eAAe,CAACC,QAAQ,CAAClB,MAAM;QACxCW,MAAMM,eAAe,CAACE,IAAI,CAACnB;IAC7B;IAEA,4CAA4C;IAC5CW,MAAMS,kBAAkB,GAAG;AAC7B"}