{"version":3,"sources":["../../../src/server/dev/hot-reloader-turbopack.ts"],"sourcesContent":["import type { Socket } from 'net'\nimport { mkdir, writeFile } from 'fs/promises'\nimport { join } from 'path'\n\nimport ws from 'next/dist/compiled/ws'\n\nimport type { OutputState } from '../../build/output/store'\nimport { store as consoleStore } from '../../build/output/store'\nimport type {\n  CompilationError,\n  HMR_ACTION_TYPES,\n  NextJsHotReloaderInterface,\n  ReloadPageAction,\n  SyncAction,\n  TurbopackConnectedAction,\n} from './hot-reloader-types'\nimport { HMR_ACTIONS_SENT_TO_BROWSER } from './hot-reloader-types'\nimport type { Update as TurbopackUpdate } from '../../build/swc'\nimport {\n  createDefineEnv,\n  type Endpoint,\n  type TurbopackResult,\n  type WrittenEndpoint,\n} from '../../build/swc'\nimport * as Log from '../../build/output/log'\nimport {\n  getVersionInfo,\n  matchNextPageBundleRequest,\n} from './hot-reloader-webpack'\nimport { BLOCKED_PAGES } from '../../shared/lib/constants'\nimport { getOverlayMiddleware } from '../../client/components/react-dev-overlay/server/middleware-turbopack'\nimport { PageNotFoundError } from '../../shared/lib/utils'\nimport { debounce } from '../utils'\nimport {\n  deleteAppClientCache,\n  deleteCache,\n} from '../../build/webpack/plugins/nextjs-require-cache-hot-reloader'\nimport {\n  clearAllModuleContexts,\n  clearModuleContext,\n} from '../lib/render-server'\nimport { denormalizePagePath } from '../../shared/lib/page-path/denormalize-page-path'\nimport { trace } from '../../trace'\nimport type { VersionInfo } from './parse-version-info'\nimport {\n  AssetMapper,\n  type ChangeSubscriptions,\n  type ClientState,\n  type EntryIssuesMap,\n  formatIssue,\n  getTurbopackJsConfig,\n  handleEntrypoints,\n  handlePagesErrorRoute,\n  handleRouteType,\n  hasEntrypointForKey,\n  msToNs,\n  processIssues,\n  type ReadyIds,\n  renderStyledStringToErrorAnsi,\n  type SendHmr,\n  type StartBuilding,\n  processTopLevelIssues,\n  type TopLevelIssuesMap,\n  isWellKnownError,\n  printNonFatalIssue,\n} from './turbopack-utils'\nimport {\n  propagateServerField,\n  type ServerFields,\n  type SetupOpts,\n} from '../lib/router-utils/setup-dev-bundler'\nimport { TurbopackManifestLoader } from './turbopack/manifest-loader'\nimport type { Entrypoints } from './turbopack/types'\nimport { findPagePathData } from './on-demand-entry-handler'\nimport type { RouteDefinition } from '../future/route-definitions/route-definition'\nimport {\n  type EntryKey,\n  getEntryKey,\n  splitEntryKey,\n} from './turbopack/entry-key'\nimport { FAST_REFRESH_RUNTIME_RELOAD } from './messages'\nimport { generateEncryptionKeyBase64 } from '../app-render/encryption-utils'\n\nconst wsServer = new ws.Server({ noServer: true })\nconst isTestMode = !!(\n  process.env.NEXT_TEST_MODE ||\n  process.env.__NEXT_TEST_MODE ||\n  process.env.DEBUG\n)\n\nexport async function createHotReloaderTurbopack(\n  opts: SetupOpts,\n  serverFields: ServerFields,\n  distDir: string\n): Promise<NextJsHotReloaderInterface> {\n  const buildId = 'development'\n  const { nextConfig, dir } = opts\n\n  const { loadBindings } =\n    require('../../build/swc') as typeof import('../../build/swc')\n\n  let bindings = await loadBindings()\n\n  // For the debugging purpose, check if createNext or equivalent next instance setup in test cases\n  // works correctly. Normally `run-test` hides output so only will be visible when `--debug` flag is used.\n  if (process.env.TURBOPACK && isTestMode) {\n    require('console').log('Creating turbopack project', {\n      dir,\n      testMode: isTestMode,\n    })\n  }\n\n  const hasRewrites =\n    opts.fsChecker.rewrites.afterFiles.length > 0 ||\n    opts.fsChecker.rewrites.beforeFiles.length > 0 ||\n    opts.fsChecker.rewrites.fallback.length > 0\n\n  const hotReloaderSpan = trace('hot-reloader', undefined, {\n    version: process.env.__NEXT_VERSION as string,\n  })\n  // Ensure the hotReloaderSpan is flushed immediately as it's the parentSpan for all processing\n  // of the current `next dev` invocation.\n  hotReloaderSpan.stop()\n\n  const encryptionKey = await generateEncryptionKeyBase64(true)\n  const project = await bindings.turbo.createProject({\n    projectPath: dir,\n    rootPath: opts.nextConfig.experimental.outputFileTracingRoot || dir,\n    nextConfig: opts.nextConfig,\n    jsConfig: await getTurbopackJsConfig(dir, nextConfig),\n    watch: true,\n    dev: true,\n    env: process.env as Record<string, string>,\n    defineEnv: createDefineEnv({\n      isTurbopack: true,\n      // TODO: Implement\n      clientRouterFilters: undefined,\n      config: nextConfig,\n      dev: true,\n      distDir,\n      fetchCacheKeyPrefix: opts.nextConfig.experimental.fetchCacheKeyPrefix,\n      hasRewrites,\n      // TODO: Implement\n      middlewareMatchers: undefined,\n    }),\n    buildId,\n    encryptionKey,\n    previewProps: opts.fsChecker.prerenderManifest.preview,\n  })\n  const entrypointsSubscription = project.entrypointsSubscribe()\n\n  const currentEntrypoints: Entrypoints = {\n    global: {\n      app: undefined,\n      document: undefined,\n      error: undefined,\n\n      middleware: undefined,\n      instrumentation: undefined,\n    },\n\n    page: new Map(),\n    app: new Map(),\n  }\n\n  const currentTopLevelIssues: TopLevelIssuesMap = new Map()\n  const currentEntryIssues: EntryIssuesMap = new Map()\n\n  const manifestLoader = new TurbopackManifestLoader({\n    buildId,\n    distDir,\n    encryptionKey,\n  })\n\n  // Dev specific\n  const changeSubscriptions: ChangeSubscriptions = new Map()\n  const serverPathState = new Map<string, string>()\n  const readyIds: ReadyIds = new Set()\n  let currentEntriesHandlingResolve: ((value?: unknown) => void) | undefined\n  let currentEntriesHandling = new Promise(\n    (resolve) => (currentEntriesHandlingResolve = resolve)\n  )\n\n  const assetMapper = new AssetMapper()\n\n  function clearRequireCache(\n    key: EntryKey,\n    writtenEndpoint: WrittenEndpoint\n  ): void {\n    // Figure out if the server files have changed\n    let hasChange = false\n    for (const { path, contentHash } of writtenEndpoint.serverPaths) {\n      // We ignore source maps\n      if (path.endsWith('.map')) continue\n      const localKey = `${key}:${path}`\n      const localHash = serverPathState.get(localKey)\n      const globalHash = serverPathState.get(path)\n      if (\n        (localHash && localHash !== contentHash) ||\n        (globalHash && globalHash !== contentHash)\n      ) {\n        hasChange = true\n        serverPathState.set(key, contentHash)\n        serverPathState.set(path, contentHash)\n      } else {\n        if (!localHash) {\n          serverPathState.set(key, contentHash)\n        }\n        if (!globalHash) {\n          serverPathState.set(path, contentHash)\n        }\n      }\n    }\n\n    if (!hasChange) {\n      return\n    }\n\n    const hasAppPaths = writtenEndpoint.serverPaths.some(({ path: p }) =>\n      p.startsWith('server/app')\n    )\n\n    if (hasAppPaths) {\n      deleteAppClientCache()\n    }\n\n    const serverPaths = writtenEndpoint.serverPaths.map(({ path: p }) =>\n      join(distDir, p)\n    )\n\n    for (const file of serverPaths) {\n      clearModuleContext(file)\n      deleteCache(file)\n    }\n\n    return\n  }\n\n  const buildingIds = new Set()\n\n  const startBuilding: StartBuilding = (id, requestUrl, forceRebuild) => {\n    if (!forceRebuild && readyIds.has(id)) {\n      return () => {}\n    }\n    if (buildingIds.size === 0) {\n      consoleStore.setState(\n        {\n          loading: true,\n          trigger: id,\n          url: requestUrl,\n        } as OutputState,\n        true\n      )\n    }\n    buildingIds.add(id)\n    return function finishBuilding() {\n      if (buildingIds.size === 0) {\n        return\n      }\n      readyIds.add(id)\n      buildingIds.delete(id)\n      if (buildingIds.size === 0) {\n        hmrEventHappened = false\n        consoleStore.setState(\n          {\n            loading: false,\n          } as OutputState,\n          true\n        )\n      }\n    }\n  }\n\n  let hmrEventHappened = false\n  let hmrHash = 0\n\n  const clients = new Set<ws>()\n  const clientStates = new WeakMap<ws, ClientState>()\n\n  function sendToClient(client: ws, payload: HMR_ACTION_TYPES) {\n    client.send(JSON.stringify(payload))\n  }\n\n  function sendEnqueuedMessages() {\n    for (const [, issueMap] of currentEntryIssues) {\n      if (\n        [...issueMap.values()].filter((i) => i.severity !== 'warning').length >\n        0\n      ) {\n        // During compilation errors we want to delay the HMR events until errors are fixed\n        return\n      }\n    }\n\n    for (const client of clients) {\n      const state = clientStates.get(client)\n      if (!state) {\n        continue\n      }\n\n      for (const [, issueMap] of state.clientIssues) {\n        if (\n          [...issueMap.values()].filter((i) => i.severity !== 'warning')\n            .length > 0\n        ) {\n          // During compilation errors we want to delay the HMR events until errors are fixed\n          return\n        }\n      }\n\n      for (const payload of state.hmrPayloads.values()) {\n        sendToClient(client, payload)\n      }\n      state.hmrPayloads.clear()\n\n      if (state.turbopackUpdates.length > 0) {\n        sendToClient(client, {\n          action: HMR_ACTIONS_SENT_TO_BROWSER.TURBOPACK_MESSAGE,\n          data: state.turbopackUpdates,\n        })\n        state.turbopackUpdates.length = 0\n      }\n    }\n  }\n  const sendEnqueuedMessagesDebounce = debounce(sendEnqueuedMessages, 2)\n\n  const sendHmr: SendHmr = (id: string, payload: HMR_ACTION_TYPES) => {\n    for (const client of clients) {\n      clientStates.get(client)?.hmrPayloads.set(id, payload)\n    }\n\n    hmrEventHappened = true\n    sendEnqueuedMessagesDebounce()\n  }\n\n  function sendTurbopackMessage(payload: TurbopackUpdate) {\n    // TODO(PACK-2049): For some reason we end up emitting hundreds of issues messages on bigger apps,\n    //   a lot of which are duplicates.\n    //   They are currently not handled on the client at all, so might as well not send them for now.\n    payload.diagnostics = []\n    payload.issues = []\n\n    for (const client of clients) {\n      clientStates.get(client)?.turbopackUpdates.push(payload)\n    }\n\n    hmrEventHappened = true\n    sendEnqueuedMessagesDebounce()\n  }\n\n  async function subscribeToChanges(\n    key: EntryKey,\n    includeIssues: boolean,\n    endpoint: Endpoint,\n    makePayload: (\n      change: TurbopackResult\n    ) => Promise<HMR_ACTION_TYPES> | HMR_ACTION_TYPES | void\n  ) {\n    if (changeSubscriptions.has(key)) {\n      return\n    }\n\n    const { side } = splitEntryKey(key)\n\n    const changedPromise = endpoint[`${side}Changed`](includeIssues)\n    changeSubscriptions.set(key, changedPromise)\n    const changed = await changedPromise\n\n    for await (const change of changed) {\n      processIssues(currentEntryIssues, key, change, false, true)\n      const payload = await makePayload(change)\n      if (payload) {\n        sendHmr(key, payload)\n      }\n    }\n  }\n\n  async function unsubscribeFromChanges(key: EntryKey) {\n    const subscription = await changeSubscriptions.get(key)\n    if (subscription) {\n      await subscription.return?.()\n      changeSubscriptions.delete(key)\n    }\n    currentEntryIssues.delete(key)\n  }\n\n  async function subscribeToHmrEvents(client: ws, id: string) {\n    const key = getEntryKey('assets', 'client', id)\n    if (!hasEntrypointForKey(currentEntrypoints, key, assetMapper)) {\n      // maybe throw an error / force the client to reload?\n      return\n    }\n\n    const state = clientStates.get(client)\n    if (!state || state.subscriptions.has(id)) {\n      return\n    }\n\n    const subscription = project!.hmrEvents(id)\n    state.subscriptions.set(id, subscription)\n\n    // The subscription will always emit once, which is the initial\n    // computation. This is not a change, so swallow it.\n    try {\n      await subscription.next()\n\n      for await (const data of subscription) {\n        processIssues(state.clientIssues, key, data, false, true)\n        if (data.type !== 'issues') {\n          sendTurbopackMessage(data)\n        }\n      }\n    } catch (e) {\n      // The client might be using an HMR session from a previous server, tell them\n      // to fully reload the page to resolve the issue. We can't use\n      // `hotReloader.send` since that would force every connected client to\n      // reload, only this client is out of date.\n      const reloadAction: ReloadPageAction = {\n        action: HMR_ACTIONS_SENT_TO_BROWSER.RELOAD_PAGE,\n      }\n      sendToClient(client, reloadAction)\n      client.close()\n      return\n    }\n  }\n\n  function unsubscribeFromHmrEvents(client: ws, id: string) {\n    const state = clientStates.get(client)\n    if (!state) {\n      return\n    }\n\n    const subscription = state.subscriptions.get(id)\n    subscription?.return!()\n\n    const key = getEntryKey('assets', 'client', id)\n    state.clientIssues.delete(key)\n  }\n\n  async function handleEntrypointsSubscription() {\n    for await (const entrypoints of entrypointsSubscription) {\n      if (!currentEntriesHandlingResolve) {\n        currentEntriesHandling = new Promise(\n          // eslint-disable-next-line no-loop-func\n          (resolve) => (currentEntriesHandlingResolve = resolve)\n        )\n      }\n\n      processTopLevelIssues(currentTopLevelIssues, entrypoints)\n\n      await handleEntrypoints({\n        entrypoints,\n\n        currentEntrypoints,\n\n        currentEntryIssues,\n        manifestLoader,\n        nextConfig: opts.nextConfig,\n        rewrites: opts.fsChecker.rewrites,\n        logErrors: true,\n\n        dev: {\n          assetMapper,\n          changeSubscriptions,\n          clients,\n          clientStates,\n          serverFields,\n\n          hooks: {\n            handleWrittenEndpoint: (id, result) => {\n              clearRequireCache(id, result)\n            },\n            propagateServerField: propagateServerField.bind(null, opts),\n            sendHmr,\n            startBuilding,\n            subscribeToChanges,\n            unsubscribeFromChanges,\n            unsubscribeFromHmrEvents,\n          },\n        },\n      })\n\n      currentEntriesHandlingResolve!()\n      currentEntriesHandlingResolve = undefined\n    }\n  }\n\n  await mkdir(join(distDir, 'server'), { recursive: true })\n  await mkdir(join(distDir, 'static', buildId), { recursive: true })\n  await writeFile(\n    join(distDir, 'package.json'),\n    JSON.stringify(\n      {\n        type: 'commonjs',\n      },\n      null,\n      2\n    )\n  )\n  const overlayMiddleware = getOverlayMiddleware(project)\n  const versionInfo: VersionInfo = await getVersionInfo(\n    isTestMode || opts.telemetry.isEnabled\n  )\n\n  const hotReloader: NextJsHotReloaderInterface = {\n    turbopackProject: project,\n    activeWebpackConfigs: undefined,\n    serverStats: null,\n    edgeServerStats: null,\n    async run(req, res, _parsedUrl) {\n      // intercept page chunks request and ensure them with turbopack\n      if (req.url?.startsWith('/_next/static/chunks/pages/')) {\n        const params = matchNextPageBundleRequest(req.url)\n\n        if (params) {\n          const decodedPagePath = `/${params.path\n            .map((param: string) => decodeURIComponent(param))\n            .join('/')}`\n\n          const denormalizedPagePath = denormalizePagePath(decodedPagePath)\n\n          await hotReloader\n            .ensurePage({\n              page: denormalizedPagePath,\n              clientOnly: false,\n              definition: undefined,\n              url: req.url,\n            })\n            .catch(console.error)\n        }\n      }\n\n      await overlayMiddleware(req, res)\n\n      // Request was not finished.\n      return { finished: undefined }\n    },\n\n    // TODO: Figure out if socket type can match the NextJsHotReloaderInterface\n    onHMR(req, socket: Socket, head) {\n      wsServer.handleUpgrade(req, socket, head, (client) => {\n        const clientIssues: EntryIssuesMap = new Map()\n        const subscriptions: Map<string, AsyncIterator<any>> = new Map()\n\n        clients.add(client)\n        clientStates.set(client, {\n          clientIssues,\n          hmrPayloads: new Map(),\n          turbopackUpdates: [],\n          subscriptions,\n        })\n\n        client.on('close', () => {\n          // Remove active subscriptions\n          for (const subscription of subscriptions.values()) {\n            subscription.return?.()\n          }\n          clientStates.delete(client)\n          clients.delete(client)\n        })\n\n        client.addEventListener('message', ({ data }) => {\n          const parsedData = JSON.parse(\n            typeof data !== 'string' ? data.toString() : data\n          )\n\n          // Next.js messages\n          switch (parsedData.event) {\n            case 'ping':\n              // Ping doesn't need additional handling in Turbopack.\n              break\n            case 'span-end': {\n              hotReloaderSpan.manualTraceChild(\n                parsedData.spanName,\n                msToNs(parsedData.startTime),\n                msToNs(parsedData.endTime),\n                parsedData.attributes\n              )\n              break\n            }\n            case 'client-hmr-latency': // { id, startTime, endTime, page, updatedModules, isPageHidden }\n              hotReloaderSpan.manualTraceChild(\n                parsedData.event,\n                msToNs(parsedData.startTime),\n                msToNs(parsedData.endTime),\n                {\n                  updatedModules: parsedData.updatedModules,\n                  page: parsedData.page,\n                  isPageHidden: parsedData.isPageHidden,\n                }\n              )\n              break\n            case 'client-error': // { errorCount, clientId }\n            case 'client-warning': // { warningCount, clientId }\n            case 'client-success': // { clientId }\n            case 'server-component-reload-page': // { clientId }\n            case 'client-reload-page': // { clientId }\n            case 'client-removed-page': // { page }\n            case 'client-full-reload': // { stackTrace, hadRuntimeError }\n              const { hadRuntimeError, dependencyChain } = parsedData\n              if (hadRuntimeError) {\n                Log.warn(FAST_REFRESH_RUNTIME_RELOAD)\n              }\n              if (\n                Array.isArray(dependencyChain) &&\n                typeof dependencyChain[0] === 'string'\n              ) {\n                const cleanedModulePath = dependencyChain[0]\n                  .replace(/^\\[project\\]/, '.')\n                  .replace(/ \\[.*\\] \\(.*\\)$/, '')\n                Log.warn(\n                  `Fast Refresh had to perform a full reload when ${cleanedModulePath} changed. Read more: https://nextjs.org/docs/messages/fast-refresh-reload`\n                )\n              }\n              break\n            case 'client-added-page':\n              // TODO\n              break\n\n            default:\n              // Might be a Turbopack message...\n              if (!parsedData.type) {\n                throw new Error(`unrecognized HMR message \"${data}\"`)\n              }\n          }\n\n          // Turbopack messages\n          switch (parsedData.type) {\n            case 'turbopack-subscribe':\n              subscribeToHmrEvents(client, parsedData.path)\n              break\n\n            case 'turbopack-unsubscribe':\n              unsubscribeFromHmrEvents(client, parsedData.path)\n              break\n\n            default:\n              if (!parsedData.event) {\n                throw new Error(`unrecognized Turbopack HMR message \"${data}\"`)\n              }\n          }\n        })\n\n        const turbopackConnected: TurbopackConnectedAction = {\n          action: HMR_ACTIONS_SENT_TO_BROWSER.TURBOPACK_CONNECTED,\n        }\n        sendToClient(client, turbopackConnected)\n\n        const errors: CompilationError[] = []\n\n        for (const entryIssues of currentEntryIssues.values()) {\n          for (const issue of entryIssues.values()) {\n            if (issue.severity !== 'warning') {\n              errors.push({\n                message: formatIssue(issue),\n              })\n            } else {\n              printNonFatalIssue(issue)\n            }\n          }\n        }\n\n        const sync: SyncAction = {\n          action: HMR_ACTIONS_SENT_TO_BROWSER.SYNC,\n          errors,\n          warnings: [],\n          hash: '',\n          versionInfo,\n        }\n\n        sendToClient(client, sync)\n      })\n    },\n\n    send(action) {\n      const payload = JSON.stringify(action)\n      for (const client of clients) {\n        client.send(payload)\n      }\n    },\n\n    setHmrServerError(_error) {\n      // Not implemented yet.\n    },\n    clearHmrServerError() {\n      // Not implemented yet.\n    },\n    async start() {},\n    async stop() {\n      // Not implemented yet.\n    },\n    async getCompilationErrors(page) {\n      const appEntryKey = getEntryKey('app', 'server', page)\n      const pagesEntryKey = getEntryKey('pages', 'server', page)\n\n      const topLevelIssues = currentTopLevelIssues.values()\n\n      const thisEntryIssues =\n        currentEntryIssues.get(appEntryKey) ??\n        currentEntryIssues.get(pagesEntryKey)\n\n      if (thisEntryIssues !== undefined && thisEntryIssues.size > 0) {\n        // If there is an error related to the requesting page we display it instead of the first error\n        return [...topLevelIssues, ...thisEntryIssues.values()]\n          .map((issue) => {\n            const formattedIssue = formatIssue(issue)\n            if (issue.severity === 'warning') {\n              printNonFatalIssue(issue)\n              return null\n            } else if (isWellKnownError(issue)) {\n              Log.error(formattedIssue)\n            }\n\n            return new Error(formattedIssue)\n          })\n          .filter((error) => error !== null)\n      }\n\n      // Otherwise, return all errors across pages\n      const errors = []\n      for (const issue of topLevelIssues) {\n        if (issue.severity !== 'warning') {\n          errors.push(new Error(formatIssue(issue)))\n        }\n      }\n      for (const entryIssues of currentEntryIssues.values()) {\n        for (const issue of entryIssues.values()) {\n          if (issue.severity !== 'warning') {\n            const message = formatIssue(issue)\n            errors.push(new Error(message))\n          } else {\n            printNonFatalIssue(issue)\n          }\n        }\n      }\n      return errors\n    },\n    async invalidate({\n      // .env files or tsconfig/jsconfig change\n      reloadAfterInvalidation,\n    }) {\n      if (reloadAfterInvalidation) {\n        await clearAllModuleContexts()\n        this.send({\n          action: HMR_ACTIONS_SENT_TO_BROWSER.SERVER_COMPONENT_CHANGES,\n        })\n      }\n    },\n    async buildFallbackError() {\n      // Not implemented yet.\n    },\n    async ensurePage({\n      page: inputPage,\n      // Unused parameters\n      // clientOnly,\n      // appPaths,\n      definition,\n      isApp,\n      url: requestUrl,\n    }) {\n      if (BLOCKED_PAGES.includes(inputPage) && inputPage !== '/_error') {\n        return\n      }\n\n      let routeDef: Pick<RouteDefinition, 'filename' | 'bundlePath' | 'page'> =\n        definition ??\n        (await findPagePathData(\n          dir,\n          inputPage,\n          nextConfig.pageExtensions,\n          opts.pagesDir,\n          opts.appDir\n        ))\n\n      const page = routeDef.page\n      const pathname = definition?.pathname ?? inputPage\n\n      if (page === '/_error') {\n        let finishBuilding = startBuilding(pathname, requestUrl, false)\n        try {\n          await handlePagesErrorRoute({\n            currentEntryIssues,\n            entrypoints: currentEntrypoints,\n            manifestLoader,\n            rewrites: opts.fsChecker.rewrites,\n            logErrors: true,\n\n            hooks: {\n              subscribeToChanges,\n              handleWrittenEndpoint: (id, result) => {\n                clearRequireCache(id, result)\n                assetMapper.setPathsForKey(id, result.clientPaths)\n              },\n            },\n          })\n        } finally {\n          finishBuilding()\n        }\n        return\n      }\n\n      await currentEntriesHandling\n\n      const isInsideAppDir = routeDef.bundlePath.startsWith('app/')\n\n      const route = isInsideAppDir\n        ? currentEntrypoints.app.get(page)\n        : currentEntrypoints.page.get(page)\n\n      if (!route) {\n        // TODO: why is this entry missing in turbopack?\n        if (page === '/middleware') return\n        if (page === '/src/middleware') return\n        if (page === '/instrumentation') return\n        if (page === '/src/instrumentation') return\n\n        throw new PageNotFoundError(`route not found ${page}`)\n      }\n\n      // We don't throw on ensureOpts.isApp === true for page-api\n      // since this can happen when app pages make\n      // api requests to page API routes.\n      if (isApp && route.type === 'page') {\n        throw new Error(`mis-matched route type: isApp && page for ${page}`)\n      }\n\n      const finishBuilding = startBuilding(pathname, requestUrl, false)\n      try {\n        await handleRouteType({\n          dev: true,\n          page,\n          pathname,\n          route,\n          currentEntryIssues,\n          entrypoints: currentEntrypoints,\n          manifestLoader,\n          readyIds,\n          rewrites: opts.fsChecker.rewrites,\n          logErrors: true,\n\n          hooks: {\n            subscribeToChanges,\n            handleWrittenEndpoint: (id, result) => {\n              clearRequireCache(id, result)\n              assetMapper.setPathsForKey(id, result.clientPaths)\n            },\n          },\n        })\n      } finally {\n        finishBuilding()\n      }\n    },\n  }\n\n  handleEntrypointsSubscription().catch((err) => {\n    console.error(err)\n    process.exit(1)\n  })\n\n  // Write empty manifests\n  await currentEntriesHandling\n  await manifestLoader.writeManifests({\n    rewrites: opts.fsChecker.rewrites,\n    pageEntrypoints: currentEntrypoints.page,\n  })\n\n  async function handleProjectUpdates() {\n    for await (const updateMessage of project.updateInfoSubscribe(30)) {\n      switch (updateMessage.updateType) {\n        case 'start': {\n          hotReloader.send({ action: HMR_ACTIONS_SENT_TO_BROWSER.BUILDING })\n          break\n        }\n        case 'end': {\n          sendEnqueuedMessages()\n\n          function addErrors(\n            errorsMap: Map<string, CompilationError>,\n            issues: EntryIssuesMap\n          ) {\n            for (const issueMap of issues.values()) {\n              for (const [key, issue] of issueMap) {\n                if (issue.severity === 'warning') continue\n                if (errorsMap.has(key)) continue\n\n                const message = formatIssue(issue)\n\n                errorsMap.set(key, {\n                  message,\n                  details: issue.detail\n                    ? renderStyledStringToErrorAnsi(issue.detail)\n                    : undefined,\n                })\n              }\n            }\n          }\n\n          const errors = new Map<string, CompilationError>()\n          addErrors(errors, currentEntryIssues)\n\n          for (const client of clients) {\n            const state = clientStates.get(client)\n            if (!state) {\n              continue\n            }\n\n            const clientErrors = new Map(errors)\n            addErrors(clientErrors, state.clientIssues)\n\n            sendToClient(client, {\n              action: HMR_ACTIONS_SENT_TO_BROWSER.BUILT,\n              hash: String(++hmrHash),\n              errors: [...clientErrors.values()],\n              warnings: [],\n            })\n          }\n\n          if (hmrEventHappened) {\n            const time = updateMessage.value.duration\n            const timeMessage =\n              time > 2000 ? `${Math.round(time / 100) / 10}s` : `${time}ms`\n            Log.event(`Compiled in ${timeMessage}`)\n            hmrEventHappened = false\n          }\n          break\n        }\n        default:\n      }\n    }\n  }\n\n  handleProjectUpdates().catch((err) => {\n    console.error(err)\n    process.exit(1)\n  })\n\n  return hotReloader\n}\n"],"names":["mkdir","writeFile","join","ws","store","consoleStore","HMR_ACTIONS_SENT_TO_BROWSER","createDefineEnv","Log","getVersionInfo","matchNextPageBundleRequest","BLOCKED_PAGES","getOverlayMiddleware","PageNotFoundError","debounce","deleteAppClientCache","deleteCache","clearAllModuleContexts","clearModuleContext","denormalizePagePath","trace","AssetMapper","formatIssue","getTurbopackJsConfig","handleEntrypoints","handlePagesErrorRoute","handleRouteType","hasEntrypointForKey","msToNs","processIssues","renderStyledStringToErrorAnsi","processTopLevelIssues","isWellKnownError","printNonFatalIssue","propagateServerField","TurbopackManifestLoader","findPagePathData","getEntryKey","splitEntryKey","FAST_REFRESH_RUNTIME_RELOAD","generateEncryptionKeyBase64","wsServer","Server","noServer","isTestMode","process","env","NEXT_TEST_MODE","__NEXT_TEST_MODE","DEBUG","createHotReloaderTurbopack","opts","serverFields","distDir","buildId","nextConfig","dir","loadBindings","require","bindings","TURBOPACK","log","testMode","hasRewrites","fsChecker","rewrites","afterFiles","length","beforeFiles","fallback","hotReloaderSpan","undefined","version","__NEXT_VERSION","stop","encryptionKey","project","turbo","createProject","projectPath","rootPath","experimental","outputFileTracingRoot","jsConfig","watch","dev","defineEnv","isTurbopack","clientRouterFilters","config","fetchCacheKeyPrefix","middlewareMatchers","previewProps","prerenderManifest","preview","entrypointsSubscription","entrypointsSubscribe","currentEntrypoints","global","app","document","error","middleware","instrumentation","page","Map","currentTopLevelIssues","currentEntryIssues","manifestLoader","changeSubscriptions","serverPathState","readyIds","Set","currentEntriesHandlingResolve","currentEntriesHandling","Promise","resolve","assetMapper","clearRequireCache","key","writtenEndpoint","hasChange","path","contentHash","serverPaths","endsWith","localKey","localHash","get","globalHash","set","hasAppPaths","some","p","startsWith","map","file","buildingIds","startBuilding","id","requestUrl","forceRebuild","has","size","setState","loading","trigger","url","add","finishBuilding","delete","hmrEventHappened","hmrHash","clients","clientStates","WeakMap","sendToClient","client","payload","send","JSON","stringify","sendEnqueuedMessages","issueMap","values","filter","i","severity","state","clientIssues","hmrPayloads","clear","turbopackUpdates","action","TURBOPACK_MESSAGE","data","sendEnqueuedMessagesDebounce","sendHmr","sendTurbopackMessage","diagnostics","issues","push","subscribeToChanges","includeIssues","endpoint","makePayload","side","changedPromise","changed","change","unsubscribeFromChanges","subscription","return","subscribeToHmrEvents","subscriptions","hmrEvents","next","type","e","reloadAction","RELOAD_PAGE","close","unsubscribeFromHmrEvents","handleEntrypointsSubscription","entrypoints","logErrors","hooks","handleWrittenEndpoint","result","bind","recursive","overlayMiddleware","versionInfo","telemetry","isEnabled","hotReloader","turbopackProject","activeWebpackConfigs","serverStats","edgeServerStats","run","req","res","_parsedUrl","params","decodedPagePath","param","decodeURIComponent","denormalizedPagePath","ensurePage","clientOnly","definition","catch","console","finished","onHMR","socket","head","handleUpgrade","on","addEventListener","parsedData","parse","toString","event","manualTraceChild","spanName","startTime","endTime","attributes","updatedModules","isPageHidden","hadRuntimeError","dependencyChain","warn","Array","isArray","cleanedModulePath","replace","Error","turbopackConnected","TURBOPACK_CONNECTED","errors","entryIssues","issue","message","sync","SYNC","warnings","hash","setHmrServerError","_error","clearHmrServerError","start","getCompilationErrors","appEntryKey","pagesEntryKey","topLevelIssues","thisEntryIssues","formattedIssue","invalidate","reloadAfterInvalidation","SERVER_COMPONENT_CHANGES","buildFallbackError","inputPage","isApp","includes","routeDef","pageExtensions","pagesDir","appDir","pathname","setPathsForKey","clientPaths","isInsideAppDir","bundlePath","route","err","exit","writeManifests","pageEntrypoints","handleProjectUpdates","updateMessage","updateInfoSubscribe","updateType","BUILDING","addErrors","errorsMap","details","detail","clientErrors","BUILT","String","time","value","duration","timeMessage","Math","round"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":"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"}