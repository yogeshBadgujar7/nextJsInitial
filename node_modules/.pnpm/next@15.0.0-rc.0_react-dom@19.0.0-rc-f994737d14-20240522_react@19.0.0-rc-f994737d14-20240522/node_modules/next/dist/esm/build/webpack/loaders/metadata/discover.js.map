{"version":3,"sources":["../../../../../src/build/webpack/loaders/metadata/discover.ts"],"sourcesContent":["import type {\n  CollectingMetadata,\n  PossibleStaticMetadataFileNameConvention,\n} from './types'\nimport path from 'path'\nimport { stringify } from 'querystring'\nimport { STATIC_METADATA_IMAGES } from '../../../../lib/metadata/is-metadata-route'\nimport { WEBPACK_RESOURCE_QUERIES } from '../../../../lib/constants'\nimport type { MetadataResolver } from '../next-app-loader'\nimport type { PageExtensions } from '../../../page-extensions-type'\n\nconst METADATA_TYPE = 'metadata'\n\n// Produce all compositions with filename (icon, apple-icon, etc.) with extensions (png, jpg, etc.)\nasync function enumMetadataFiles(\n  dir: string,\n  filename: string,\n  extensions: readonly string[],\n  {\n    metadataResolver,\n    // When set to true, possible filename without extension could: icon, icon0, ..., icon9\n    numericSuffix,\n  }: {\n    metadataResolver: MetadataResolver\n    numericSuffix: boolean\n  }\n): Promise<string[]> {\n  const collectedFiles: string[] = []\n\n  const possibleFileNames = [filename].concat(\n    numericSuffix\n      ? Array(10)\n          .fill(0)\n          .map((_, index) => filename + index)\n      : []\n  )\n  for (const name of possibleFileNames) {\n    const resolved = await metadataResolver(dir, name, extensions)\n    if (resolved) {\n      collectedFiles.push(resolved)\n    }\n  }\n\n  return collectedFiles\n}\n\nexport async function createStaticMetadataFromRoute(\n  resolvedDir: string,\n  {\n    segment,\n    metadataResolver,\n    isRootLayoutOrRootPage,\n    pageExtensions,\n    basePath,\n  }: {\n    segment: string\n    metadataResolver: MetadataResolver\n    isRootLayoutOrRootPage: boolean\n    pageExtensions: PageExtensions\n    basePath: string\n  }\n) {\n  let hasStaticMetadataFiles = false\n  const staticImagesMetadata: CollectingMetadata = {\n    icon: [],\n    apple: [],\n    twitter: [],\n    openGraph: [],\n    manifest: undefined,\n  }\n\n  async function collectIconModuleIfExists(\n    type: PossibleStaticMetadataFileNameConvention\n  ) {\n    if (type === 'manifest') {\n      const staticManifestExtension = ['webmanifest', 'json']\n      const manifestFile = await enumMetadataFiles(\n        resolvedDir,\n        'manifest',\n        staticManifestExtension.concat(pageExtensions),\n        { metadataResolver, numericSuffix: false }\n      )\n      if (manifestFile.length > 0) {\n        hasStaticMetadataFiles = true\n        const { name, ext } = path.parse(manifestFile[0])\n        const extension = staticManifestExtension.includes(ext.slice(1))\n          ? ext.slice(1)\n          : 'webmanifest'\n        staticImagesMetadata.manifest = JSON.stringify(`/${name}.${extension}`)\n      }\n      return\n    }\n\n    const resolvedMetadataFiles = await enumMetadataFiles(\n      resolvedDir,\n      STATIC_METADATA_IMAGES[type].filename,\n      [\n        ...STATIC_METADATA_IMAGES[type].extensions,\n        ...(type === 'favicon' ? [] : pageExtensions),\n      ],\n      { metadataResolver, numericSuffix: true }\n    )\n    resolvedMetadataFiles\n      .sort((a, b) => a.localeCompare(b))\n      .forEach((filepath) => {\n        const imageModuleImportSource = `next-metadata-image-loader?${stringify(\n          {\n            type,\n            segment,\n            basePath,\n            pageExtensions,\n          }\n          // WEBPACK_RESOURCE_QUERIES.metadata query here only for filtering out applying to image loader\n        )}!${filepath}?${WEBPACK_RESOURCE_QUERIES.metadata}`\n\n        const imageModule = `(async (props) => (await import(/* webpackMode: \"eager\" */ ${JSON.stringify(\n          imageModuleImportSource\n        )})).default(props))`\n        hasStaticMetadataFiles = true\n        if (type === 'favicon') {\n          staticImagesMetadata.icon.unshift(imageModule)\n        } else {\n          staticImagesMetadata[type].push(imageModule)\n        }\n      })\n  }\n\n  // Intentionally make these serial to reuse directory access cache.\n  await collectIconModuleIfExists('icon')\n  await collectIconModuleIfExists('apple')\n  await collectIconModuleIfExists('openGraph')\n  await collectIconModuleIfExists('twitter')\n  if (isRootLayoutOrRootPage) {\n    await collectIconModuleIfExists('favicon')\n    await collectIconModuleIfExists('manifest')\n  }\n\n  return hasStaticMetadataFiles ? staticImagesMetadata : null\n}\n\nexport function createMetadataExportsCode(\n  metadata: Awaited<ReturnType<typeof createStaticMetadataFromRoute>>\n) {\n  return metadata\n    ? `${METADATA_TYPE}: {\n    icon: [${metadata.icon.join(',')}],\n    apple: [${metadata.apple.join(',')}],\n    openGraph: [${metadata.openGraph.join(',')}],\n    twitter: [${metadata.twitter.join(',')}],\n    manifest: ${metadata.manifest ? metadata.manifest : 'undefined'}\n  }`\n    : ''\n}\n"],"names":["path","stringify","STATIC_METADATA_IMAGES","WEBPACK_RESOURCE_QUERIES","METADATA_TYPE","enumMetadataFiles","dir","filename","extensions","metadataResolver","numericSuffix","collectedFiles","possibleFileNames","concat","Array","fill","map","_","index","name","resolved","push","createStaticMetadataFromRoute","resolvedDir","segment","isRootLayoutOrRootPage","pageExtensions","basePath","hasStaticMetadataFiles","staticImagesMetadata","icon","apple","twitter","openGraph","manifest","undefined","collectIconModuleIfExists","type","staticManifestExtension","manifestFile","length","ext","parse","extension","includes","slice","JSON","resolvedMetadataFiles","sort","a","b","localeCompare","forEach","filepath","imageModuleImportSource","metadata","imageModule","unshift","createMetadataExportsCode","join"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":"AAIA,OAAOA,UAAU,OAAM;AACvB,SAASC,SAAS,QAAQ,cAAa;AACvC,SAASC,sBAAsB,QAAQ,6CAA4C;AACnF,SAASC,wBAAwB,QAAQ,4BAA2B;AAIpE,MAAMC,gBAAgB;AAEtB,mGAAmG;AACnG,eAAeC,kBACbC,GAAW,EACXC,QAAgB,EAChBC,UAA6B,EAC7B,EACEC,gBAAgB,EAChB,uFAAuF;AACvFC,aAAa,EAId;IAED,MAAMC,iBAA2B,EAAE;IAEnC,MAAMC,oBAAoB;QAACL;KAAS,CAACM,MAAM,CACzCH,gBACII,MAAM,IACHC,IAAI,CAAC,GACLC,GAAG,CAAC,CAACC,GAAGC,QAAUX,WAAWW,SAChC,EAAE;IAER,KAAK,MAAMC,QAAQP,kBAAmB;QACpC,MAAMQ,WAAW,MAAMX,iBAAiBH,KAAKa,MAAMX;QACnD,IAAIY,UAAU;YACZT,eAAeU,IAAI,CAACD;QACtB;IACF;IAEA,OAAOT;AACT;AAEA,OAAO,eAAeW,8BACpBC,WAAmB,EACnB,EACEC,OAAO,EACPf,gBAAgB,EAChBgB,sBAAsB,EACtBC,cAAc,EACdC,QAAQ,EAOT;IAED,IAAIC,yBAAyB;IAC7B,MAAMC,uBAA2C;QAC/CC,MAAM,EAAE;QACRC,OAAO,EAAE;QACTC,SAAS,EAAE;QACXC,WAAW,EAAE;QACbC,UAAUC;IACZ;IAEA,eAAeC,0BACbC,IAA8C;QAE9C,IAAIA,SAAS,YAAY;YACvB,MAAMC,0BAA0B;gBAAC;gBAAe;aAAO;YACvD,MAAMC,eAAe,MAAMlC,kBACzBkB,aACA,YACAe,wBAAwBzB,MAAM,CAACa,iBAC/B;gBAAEjB;gBAAkBC,eAAe;YAAM;YAE3C,IAAI6B,aAAaC,MAAM,GAAG,GAAG;gBAC3BZ,yBAAyB;gBACzB,MAAM,EAAET,IAAI,EAAEsB,GAAG,EAAE,GAAGzC,KAAK0C,KAAK,CAACH,YAAY,CAAC,EAAE;gBAChD,MAAMI,YAAYL,wBAAwBM,QAAQ,CAACH,IAAII,KAAK,CAAC,MACzDJ,IAAII,KAAK,CAAC,KACV;gBACJhB,qBAAqBK,QAAQ,GAAGY,KAAK7C,SAAS,CAAC,CAAC,CAAC,EAAEkB,KAAK,CAAC,EAAEwB,UAAU,CAAC;YACxE;YACA;QACF;QAEA,MAAMI,wBAAwB,MAAM1C,kBAClCkB,aACArB,sBAAsB,CAACmC,KAAK,CAAC9B,QAAQ,EACrC;eACKL,sBAAsB,CAACmC,KAAK,CAAC7B,UAAU;eACtC6B,SAAS,YAAY,EAAE,GAAGX;SAC/B,EACD;YAAEjB;YAAkBC,eAAe;QAAK;QAE1CqC,sBACGC,IAAI,CAAC,CAACC,GAAGC,IAAMD,EAAEE,aAAa,CAACD,IAC/BE,OAAO,CAAC,CAACC;YACR,MAAMC,0BAA0B,CAAC,2BAA2B,EAAErD,UAC5D;gBACEoC;gBACAb;gBACAG;gBACAD;YACF,GAEA,CAAC,EAAE2B,SAAS,CAAC,EAAElD,yBAAyBoD,QAAQ,CAAC,CAAC;YAEpD,MAAMC,cAAc,CAAC,2DAA2D,EAAEV,KAAK7C,SAAS,CAC9FqD,yBACA,kBAAkB,CAAC;YACrB1B,yBAAyB;YACzB,IAAIS,SAAS,WAAW;gBACtBR,qBAAqBC,IAAI,CAAC2B,OAAO,CAACD;YACpC,OAAO;gBACL3B,oBAAoB,CAACQ,KAAK,CAAChB,IAAI,CAACmC;YAClC;QACF;IACJ;IAEA,mEAAmE;IACnE,MAAMpB,0BAA0B;IAChC,MAAMA,0BAA0B;IAChC,MAAMA,0BAA0B;IAChC,MAAMA,0BAA0B;IAChC,IAAIX,wBAAwB;QAC1B,MAAMW,0BAA0B;QAChC,MAAMA,0BAA0B;IAClC;IAEA,OAAOR,yBAAyBC,uBAAuB;AACzD;AAEA,OAAO,SAAS6B,0BACdH,QAAmE;IAEnE,OAAOA,WACH,CAAC,EAAEnD,cAAc;WACZ,EAAEmD,SAASzB,IAAI,CAAC6B,IAAI,CAAC,KAAK;YACzB,EAAEJ,SAASxB,KAAK,CAAC4B,IAAI,CAAC,KAAK;gBACvB,EAAEJ,SAAStB,SAAS,CAAC0B,IAAI,CAAC,KAAK;cACjC,EAAEJ,SAASvB,OAAO,CAAC2B,IAAI,CAAC,KAAK;cAC7B,EAAEJ,SAASrB,QAAQ,GAAGqB,SAASrB,QAAQ,GAAG,YAAY;GACjE,CAAC,GACE;AACN"}