{"version":3,"sources":["../../../../src/build/webpack/plugins/build-manifest-plugin.ts"],"sourcesContent":["import type { Rewrite, CustomRoutes } from '../../../lib/load-custom-routes'\nimport devalue from 'next/dist/compiled/devalue'\nimport { webpack, sources } from 'next/dist/compiled/webpack/webpack'\nimport {\n  BUILD_MANIFEST,\n  MIDDLEWARE_BUILD_MANIFEST,\n  CLIENT_STATIC_FILES_PATH,\n  CLIENT_STATIC_FILES_RUNTIME_MAIN,\n  CLIENT_STATIC_FILES_RUNTIME_MAIN_APP,\n  CLIENT_STATIC_FILES_RUNTIME_POLYFILLS_SYMBOL,\n  CLIENT_STATIC_FILES_RUNTIME_REACT_REFRESH,\n  CLIENT_STATIC_FILES_RUNTIME_AMP,\n  SYSTEM_ENTRYPOINTS,\n} from '../../../shared/lib/constants'\nimport type { BuildManifest } from '../../../server/get-page-files'\nimport getRouteFromEntrypoint from '../../../server/get-route-from-entrypoint'\nimport { ampFirstEntryNamesMap } from './next-drop-client-page-plugin'\nimport { getSortedRoutes } from '../../../shared/lib/router/utils'\nimport { spans } from './profiling-plugin'\n\ntype DeepMutable<T> = { -readonly [P in keyof T]: DeepMutable<T[P]> }\n\nexport type ClientBuildManifest = {\n  [key: string]: string[]\n}\n\n// Add the runtime ssg manifest file as a lazy-loaded file dependency.\n// We also stub this file out for development mode (when it is not\n// generated).\nexport const srcEmptySsgManifest = `self.__SSG_MANIFEST=new Set;self.__SSG_MANIFEST_CB&&self.__SSG_MANIFEST_CB()`\n\n// nodejs: '/static/<build id>/low-priority.js'\nfunction buildNodejsLowPriorityPath(filename: string, buildId: string) {\n  return `${CLIENT_STATIC_FILES_PATH}/${buildId}/${filename}`\n}\n\nfunction createEdgeRuntimeManifest(originAssetMap: BuildManifest): string {\n  const manifestFilenames = ['_buildManifest.js', '_ssgManifest.js']\n\n  const assetMap: BuildManifest = {\n    ...originAssetMap,\n    lowPriorityFiles: [],\n  }\n\n  const manifestDefCode = `self.__BUILD_MANIFEST = ${JSON.stringify(\n    assetMap,\n    null,\n    2\n  )};\\n`\n  // edge lowPriorityFiles item: '\"/static/\" + process.env.__NEXT_BUILD_ID + \"/low-priority.js\"'.\n  // Since lowPriorityFiles is not fixed and relying on `process.env.__NEXT_BUILD_ID`, we'll produce code creating it dynamically.\n  const lowPriorityFilesCode =\n    `self.__BUILD_MANIFEST.lowPriorityFiles = [\\n` +\n    manifestFilenames\n      .map((filename) => {\n        return `\"/static/\" + process.env.__NEXT_BUILD_ID + \"/${filename}\",\\n`\n      })\n      .join(',') +\n    `\\n];`\n\n  return manifestDefCode + lowPriorityFilesCode\n}\n\nfunction normalizeRewrite(item: {\n  source: string\n  destination: string\n  has?: any\n}): CustomRoutes['rewrites']['beforeFiles'][0] {\n  return {\n    has: item.has,\n    source: item.source,\n    destination: item.destination,\n  }\n}\n\nexport function normalizeRewritesForBuildManifest(\n  rewrites: CustomRoutes['rewrites']\n): CustomRoutes['rewrites'] {\n  return {\n    afterFiles: rewrites.afterFiles?.map((item) => normalizeRewrite(item)),\n    beforeFiles: rewrites.beforeFiles?.map((item) => normalizeRewrite(item)),\n    fallback: rewrites.fallback?.map((item) => normalizeRewrite(item)),\n  }\n}\n\n// This function takes the asset map generated in BuildManifestPlugin and creates a\n// reduced version to send to the client.\nfunction generateClientManifest(\n  compiler: any,\n  compilation: any,\n  assetMap: BuildManifest,\n  rewrites: CustomRoutes['rewrites']\n): string | undefined {\n  const compilationSpan = spans.get(compilation) || spans.get(compiler)\n  const genClientManifestSpan = compilationSpan?.traceChild(\n    'NextJsBuildManifest-generateClientManifest'\n  )\n\n  return genClientManifestSpan?.traceFn(() => {\n    const clientManifest: ClientBuildManifest = {\n      __rewrites: normalizeRewritesForBuildManifest(rewrites) as any,\n    }\n    const appDependencies = new Set(assetMap.pages['/_app'])\n    const sortedPageKeys = getSortedRoutes(Object.keys(assetMap.pages))\n\n    sortedPageKeys.forEach((page) => {\n      const dependencies = assetMap.pages[page]\n\n      if (page === '/_app') return\n      // Filter out dependencies in the _app entry, because those will have already\n      // been loaded by the client prior to a navigation event\n      const filteredDeps = dependencies.filter(\n        (dep) => !appDependencies.has(dep)\n      )\n\n      // The manifest can omit the page if it has no requirements\n      if (filteredDeps.length) {\n        clientManifest[page] = filteredDeps\n      }\n    })\n    // provide the sorted pages as an array so we don't rely on the object's keys\n    // being in order and we don't slow down look-up time for page assets\n    clientManifest.sortedPages = sortedPageKeys\n\n    return devalue(clientManifest)\n  })\n}\n\nexport function getEntrypointFiles(entrypoint: any): string[] {\n  return (\n    entrypoint\n      ?.getFiles()\n      .filter((file: string) => {\n        // We don't want to include `.hot-update.js` files into the initial page\n        return /(?<!\\.hot-update)\\.(js|css)($|\\?)/.test(file)\n      })\n      .map((file: string) => file.replace(/\\\\/g, '/')) ?? []\n  )\n}\n\nexport const processRoute = (r: Rewrite) => {\n  const rewrite = { ...r }\n\n  // omit external rewrite destinations since these aren't\n  // handled client-side\n  if (!rewrite.destination.startsWith('/')) {\n    delete (rewrite as any).destination\n  }\n  return rewrite\n}\n\n// This plugin creates a build-manifest.json for all assets that are being output\n// It has a mapping of \"entry\" filename to real filename. Because the real filename can be hashed in production\nexport default class BuildManifestPlugin {\n  private buildId: string\n  private rewrites: CustomRoutes['rewrites']\n  private isDevFallback: boolean\n  private appDirEnabled: boolean\n\n  constructor(options: {\n    buildId: string\n    rewrites: CustomRoutes['rewrites']\n    isDevFallback?: boolean\n    appDirEnabled: boolean\n  }) {\n    this.buildId = options.buildId\n    this.isDevFallback = !!options.isDevFallback\n    this.rewrites = {\n      beforeFiles: [],\n      afterFiles: [],\n      fallback: [],\n    }\n    this.appDirEnabled = options.appDirEnabled\n    this.rewrites.beforeFiles = options.rewrites.beforeFiles.map(processRoute)\n    this.rewrites.afterFiles = options.rewrites.afterFiles.map(processRoute)\n    this.rewrites.fallback = options.rewrites.fallback.map(processRoute)\n  }\n\n  createAssets(compiler: any, compilation: any, assets: any) {\n    const compilationSpan = spans.get(compilation) || spans.get(compiler)\n    const createAssetsSpan = compilationSpan?.traceChild(\n      'NextJsBuildManifest-createassets'\n    )\n    return createAssetsSpan?.traceFn(() => {\n      const entrypoints: Map<string, any> = compilation.entrypoints\n      const assetMap: DeepMutable<BuildManifest> = {\n        polyfillFiles: [],\n        devFiles: [],\n        ampDevFiles: [],\n        lowPriorityFiles: [],\n        rootMainFiles: [],\n        pages: { '/_app': [] },\n        ampFirstPages: [],\n      }\n\n      const ampFirstEntryNames = ampFirstEntryNamesMap.get(compilation)\n      if (ampFirstEntryNames) {\n        for (const entryName of ampFirstEntryNames) {\n          const pagePath = getRouteFromEntrypoint(entryName)\n          if (!pagePath) {\n            continue\n          }\n\n          assetMap.ampFirstPages.push(pagePath)\n        }\n      }\n\n      const mainFiles = new Set(\n        getEntrypointFiles(entrypoints.get(CLIENT_STATIC_FILES_RUNTIME_MAIN))\n      )\n\n      if (this.appDirEnabled) {\n        assetMap.rootMainFiles = [\n          ...new Set(\n            getEntrypointFiles(\n              entrypoints.get(CLIENT_STATIC_FILES_RUNTIME_MAIN_APP)\n            )\n          ),\n        ]\n      }\n\n      const compilationAssets: {\n        name: string\n        source: typeof sources.RawSource\n        info: object\n      }[] = compilation.getAssets()\n\n      assetMap.polyfillFiles = compilationAssets\n        .filter((p) => {\n          // Ensure only .js files are passed through\n          if (!p.name.endsWith('.js')) {\n            return false\n          }\n\n          return (\n            p.info && CLIENT_STATIC_FILES_RUNTIME_POLYFILLS_SYMBOL in p.info\n          )\n        })\n        .map((v) => v.name)\n\n      assetMap.devFiles = getEntrypointFiles(\n        entrypoints.get(CLIENT_STATIC_FILES_RUNTIME_REACT_REFRESH)\n      ).filter((file) => !mainFiles.has(file))\n\n      assetMap.ampDevFiles = getEntrypointFiles(\n        entrypoints.get(CLIENT_STATIC_FILES_RUNTIME_AMP)\n      )\n\n      for (const entrypoint of compilation.entrypoints.values()) {\n        if (SYSTEM_ENTRYPOINTS.has(entrypoint.name)) continue\n        const pagePath = getRouteFromEntrypoint(entrypoint.name)\n\n        if (!pagePath) {\n          continue\n        }\n\n        const filesForPage = getEntrypointFiles(entrypoint)\n\n        assetMap.pages[pagePath] = [...new Set([...mainFiles, ...filesForPage])]\n      }\n\n      if (!this.isDevFallback) {\n        // Add the runtime build manifest file (generated later in this file)\n        // as a dependency for the app. If the flag is false, the file won't be\n        // downloaded by the client.\n        const buildManifestPath = buildNodejsLowPriorityPath(\n          '_buildManifest.js',\n          this.buildId\n        )\n        const ssgManifestPath = buildNodejsLowPriorityPath(\n          '_ssgManifest.js',\n          this.buildId\n        )\n        assetMap.lowPriorityFiles.push(buildManifestPath, ssgManifestPath)\n        assets[ssgManifestPath] = new sources.RawSource(srcEmptySsgManifest)\n      }\n\n      assetMap.pages = Object.keys(assetMap.pages)\n        .sort()\n        .reduce(\n          // eslint-disable-next-line\n          (a, c) => ((a[c] = assetMap.pages[c]), a),\n          {} as typeof assetMap.pages\n        )\n\n      let buildManifestName = BUILD_MANIFEST\n\n      if (this.isDevFallback) {\n        buildManifestName = `fallback-${BUILD_MANIFEST}`\n      }\n\n      assets[buildManifestName] = new sources.RawSource(\n        JSON.stringify(assetMap, null, 2)\n      )\n\n      assets[`server/${MIDDLEWARE_BUILD_MANIFEST}.js`] = new sources.RawSource(\n        `${createEdgeRuntimeManifest(assetMap)}`\n      )\n\n      if (!this.isDevFallback) {\n        const clientManifestPath = `${CLIENT_STATIC_FILES_PATH}/${this.buildId}/_buildManifest.js`\n\n        assets[clientManifestPath] = new sources.RawSource(\n          `self.__BUILD_MANIFEST = ${generateClientManifest(\n            compiler,\n            compilation,\n            assetMap,\n            this.rewrites\n          )};self.__BUILD_MANIFEST_CB && self.__BUILD_MANIFEST_CB()`\n        )\n      }\n\n      return assets\n    })\n  }\n\n  apply(compiler: webpack.Compiler) {\n    compiler.hooks.make.tap('NextJsBuildManifest', (compilation) => {\n      compilation.hooks.processAssets.tap(\n        {\n          name: 'NextJsBuildManifest',\n          stage: webpack.Compilation.PROCESS_ASSETS_STAGE_ADDITIONS,\n        },\n        (assets: any) => {\n          this.createAssets(compiler, compilation, assets)\n        }\n      )\n    })\n    return\n  }\n}\n"],"names":["devalue","webpack","sources","BUILD_MANIFEST","MIDDLEWARE_BUILD_MANIFEST","CLIENT_STATIC_FILES_PATH","CLIENT_STATIC_FILES_RUNTIME_MAIN","CLIENT_STATIC_FILES_RUNTIME_MAIN_APP","CLIENT_STATIC_FILES_RUNTIME_POLYFILLS_SYMBOL","CLIENT_STATIC_FILES_RUNTIME_REACT_REFRESH","CLIENT_STATIC_FILES_RUNTIME_AMP","SYSTEM_ENTRYPOINTS","getRouteFromEntrypoint","ampFirstEntryNamesMap","getSortedRoutes","spans","srcEmptySsgManifest","buildNodejsLowPriorityPath","filename","buildId","createEdgeRuntimeManifest","originAssetMap","manifestFilenames","assetMap","lowPriorityFiles","manifestDefCode","JSON","stringify","lowPriorityFilesCode","map","join","normalizeRewrite","item","has","source","destination","normalizeRewritesForBuildManifest","rewrites","afterFiles","beforeFiles","fallback","generateClientManifest","compiler","compilation","compilationSpan","get","genClientManifestSpan","traceChild","traceFn","clientManifest","__rewrites","appDependencies","Set","pages","sortedPageKeys","Object","keys","forEach","page","dependencies","filteredDeps","filter","dep","length","sortedPages","getEntrypointFiles","entrypoint","getFiles","file","test","replace","processRoute","r","rewrite","startsWith","BuildManifestPlugin","constructor","options","isDevFallback","appDirEnabled","createAssets","assets","createAssetsSpan","entrypoints","polyfillFiles","devFiles","ampDevFiles","rootMainFiles","ampFirstPages","ampFirstEntryNames","entryName","pagePath","push","mainFiles","compilationAssets","getAssets","p","name","endsWith","info","v","values","filesForPage","buildManifestPath","ssgManifestPath","RawSource","sort","reduce","a","c","buildManifestName","clientManifestPath","apply","hooks","make","tap","processAssets","stage","Compilation","PROCESS_ASSETS_STAGE_ADDITIONS"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":"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"}