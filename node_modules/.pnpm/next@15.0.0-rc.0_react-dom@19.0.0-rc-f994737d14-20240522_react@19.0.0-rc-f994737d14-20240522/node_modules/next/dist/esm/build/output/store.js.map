{"version":3,"sources":["../../../src/build/output/store.ts"],"sourcesContent":["import createStore from 'next/dist/compiled/unistore'\nimport stripAnsi from 'next/dist/compiled/strip-ansi'\nimport { type Span, flushAllTraces, trace } from '../../trace'\nimport { teardownHeapProfiler, teardownTraceSubscriber } from '../swc'\nimport * as Log from './log'\n\nconst MAX_LOG_SKIP_DURATION = 500 // 500ms\n\nexport type OutputState =\n  | { bootstrap: true; appUrl: string | null; bindAddr: string | null }\n  | ({ bootstrap: false; appUrl: string | null; bindAddr: string | null } & (\n      | {\n          loading: true\n          trigger: string | undefined\n          url: string | undefined\n        }\n      | {\n          loading: false\n          typeChecking: boolean\n          totalModulesCount: number\n          errors: string[] | null\n          warnings: string[] | null\n          hasEdgeServer: boolean\n        }\n    ))\n\nconst internalSegments = ['[[...__metadata_id__]]', '[__metadata_id__]']\nexport function formatTrigger(trigger: string) {\n  for (const segment of internalSegments) {\n    if (trigger.includes(segment)) {\n      trigger = trigger.replace(segment, '')\n    }\n  }\n  if (trigger.length > 1 && trigger.endsWith('/')) {\n    trigger = trigger.slice(0, -1)\n  }\n  return trigger\n}\n\nexport const store = createStore<OutputState>({\n  appUrl: null,\n  bindAddr: null,\n  bootstrap: true,\n})\n\nlet lastStore: OutputState = { appUrl: null, bindAddr: null, bootstrap: true }\nfunction hasStoreChanged(nextStore: OutputState) {\n  if (\n    (\n      [\n        ...new Set([...Object.keys(lastStore), ...Object.keys(nextStore)]),\n      ] as Array<keyof OutputState>\n    ).every((key) => Object.is(lastStore[key], nextStore[key]))\n  ) {\n    return false\n  }\n\n  lastStore = nextStore\n  return true\n}\n\nlet startTime = 0\nlet trigger = '' // default, use empty string for trigger\nlet triggerUrl: string | undefined = undefined\nlet loadingLogTimer: NodeJS.Timeout | null = null\nlet traceSpan: Span | null = null\n\nstore.subscribe((state) => {\n  if (!hasStoreChanged(state)) {\n    return\n  }\n\n  if (state.bootstrap) {\n    return\n  }\n\n  if (state.loading) {\n    if (state.trigger) {\n      trigger = formatTrigger(state.trigger)\n      triggerUrl = state.url\n      if (trigger !== 'initial') {\n        traceSpan = trace('compile-path', undefined, {\n          trigger: trigger,\n        })\n        if (!loadingLogTimer) {\n          // Only log compiling if compiled is not finished in 3 seconds\n          loadingLogTimer = setTimeout(() => {\n            if (\n              triggerUrl &&\n              triggerUrl !== trigger &&\n              process.env.NEXT_TRIGGER_URL\n            ) {\n              Log.wait(`Compiling ${trigger} (${triggerUrl}) ...`)\n            } else {\n              Log.wait(`Compiling ${trigger} ...`)\n            }\n          }, MAX_LOG_SKIP_DURATION)\n        }\n      }\n    }\n    if (startTime === 0) {\n      startTime = Date.now()\n    }\n    return\n  }\n\n  if (state.errors) {\n    // Log compilation errors\n    Log.error(state.errors[0])\n\n    const cleanError = stripAnsi(state.errors[0])\n    if (cleanError.indexOf('SyntaxError') > -1) {\n      const matches = cleanError.match(/\\[.*\\]=/)\n      if (matches) {\n        for (const match of matches) {\n          const prop = (match.split(']').shift() || '').slice(1)\n          console.log(\n            `AMP bind syntax [${prop}]='' is not supported in JSX, use 'data-amp-bind-${prop}' instead. https://nextjs.org/docs/messages/amp-bind-jsx-alt`\n          )\n        }\n        return\n      }\n    }\n    startTime = 0\n    // Ensure traces are flushed after each compile in development mode\n    flushAllTraces()\n    teardownTraceSubscriber()\n    teardownHeapProfiler()\n    return\n  }\n\n  let timeMessage = ''\n  if (startTime) {\n    const time = Date.now() - startTime\n    startTime = 0\n\n    timeMessage =\n      ' ' +\n      (time > 2000 ? `in ${Math.round(time / 100) / 10}s` : `in ${time}ms`)\n  }\n\n  let modulesMessage = ''\n  if (state.totalModulesCount) {\n    modulesMessage = ` (${state.totalModulesCount} modules)`\n  }\n\n  if (state.warnings) {\n    Log.warn(state.warnings.join('\\n\\n'))\n    // Ensure traces are flushed after each compile in development mode\n    flushAllTraces()\n    teardownTraceSubscriber()\n    teardownHeapProfiler()\n    return\n  }\n\n  if (state.typeChecking) {\n    Log.info(\n      `bundled ${trigger}${timeMessage}${modulesMessage}, type checking...`\n    )\n    return\n  }\n\n  if (trigger === 'initial') {\n    trigger = ''\n  } else {\n    if (loadingLogTimer) {\n      clearTimeout(loadingLogTimer)\n      loadingLogTimer = null\n    }\n    if (traceSpan) {\n      traceSpan.stop()\n      traceSpan = null\n    }\n    Log.event(\n      `Compiled${trigger ? ' ' + trigger : ''}${timeMessage}${modulesMessage}`\n    )\n    trigger = ''\n  }\n\n  // Ensure traces are flushed after each compile in development mode\n  flushAllTraces()\n  teardownTraceSubscriber()\n  teardownHeapProfiler()\n})\n"],"names":["createStore","stripAnsi","flushAllTraces","trace","teardownHeapProfiler","teardownTraceSubscriber","Log","MAX_LOG_SKIP_DURATION","internalSegments","formatTrigger","trigger","segment","includes","replace","length","endsWith","slice","store","appUrl","bindAddr","bootstrap","lastStore","hasStoreChanged","nextStore","Set","Object","keys","every","key","is","startTime","triggerUrl","undefined","loadingLogTimer","traceSpan","subscribe","state","loading","url","setTimeout","process","env","NEXT_TRIGGER_URL","wait","Date","now","errors","error","cleanError","indexOf","matches","match","prop","split","shift","console","log","timeMessage","time","Math","round","modulesMessage","totalModulesCount","warnings","warn","join","typeChecking","info","clearTimeout","stop","event"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":"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"}